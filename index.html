<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELOTH</title>
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Press Start 2P font for the retro pixel aesthetic -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        /* Custom font and shadow to mimic pixel art */
        .pixel-font {
            font-family: 'Press Start 2P', cursive;
            text-shadow: 4px 4px 8px rgba(0, 255, 64, 0.7); /* Matching the Compose green glow */
        }
        
        /* Error screen text styling (Sans-Serif, Italic, Light) */
        .error-font {
            font-family: sans-serif;
            font-style: italic;
            font-weight: 300;
            line-height: 1.75rem; /* Equivalent to 28.sp */
        }

        /* Initial state for the title's off-screen position */
        .title-start-position {
            /* Force title container off-screen */
            transform: translateY(-250px);
        }
        
        /* The CSS transition for the smooth title movement (5.6 second uniform descent) */
        #boot-sequence-container {
            transition: transform 5600ms linear;
        }

        /* Styling for the red button */
        .nes-button {
            background-color: #C82400; 
            box-shadow: 0 8px 0 #9E1C00; 
            transition: all 0.1s ease-in-out;
        }

        .nes-button:active {
            box-shadow: 0 2px 0 #9E1C00;
            transform: translateY(6px);
        }

        /* Styling for the back button */
        #back-button {
            background-color: transparent;
            border: none;
            color: #FCFF00; /* Eloth Yellow for visibility */
            font-size: 2rem;
            line-height: 1.5rem;
            padding: 0.5rem;
            cursor: pointer;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            /* Added transition-opacity to HTML for smooth fade */
            transition: color 0.2s ease, opacity 0.3s ease; 
        }

        #back-button:hover {
            color: #ffffff; /* White on hover */
        }

        /* Ensure the body and HTML cover the full viewport */
        html, body {
            height: 100%;
            margin: 0;
            background-color: black;
        }
        
        /* --- RED FLASH EFFECT CSS (Controlled by JS for precision) --- */
        #red-flash-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px; 
            height: 50px;
            background-color: #C82400; 
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0); /* Start scaled down and centered */
            opacity: 0; 
            z-index: 50; 
            pointer-events: none;
            /* JS will manage the transform and opacity transitions */
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'eloth-red': '#C82400',
                        'eloth-yellow': '#FCFF00',
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-black text-white antialiased">

<!-- Invisible Audio Element for Startup Sound -->
<audio id="boot-sound" src="/assets/lancement.mp3" preload="auto"></audio> 
<!-- Invisible Audio Element for Transition FX -->
<audio id="transition-fx" src="/assets/fx_transition.mp3" preload="auto"></audio>


<div id="app" class="relative w-full h-full min-h-screen flex items-center justify-center overflow-hidden">
    <!-- 1. Starfield Canvas Background -->
    <canvas id="starfield" class="absolute inset-0 w-full h-full"></canvas>

    <!-- Back Button (Top Left) - Starts hidden (opacity-0) -->
    <button id="back-button" class="absolute top-4 left-4 z-50 pixel-font opacity-0" onclick="goBack()">
        &lt;
    </button>

    <!-- Red Flash Element (Transition managed by JS) -->
    <div id="red-flash-effect"></div>

    <!-- 2. Main Content Container -->
    <div id="content" class="relative z-10 w-full h-full flex flex-col items-center justify-center">

        <!-- Initial "DÉMARRER" button overlay -->
        <div id="initial-start" class="absolute inset-0 bg-black flex items-center justify-center z-20 transition-opacity duration-500">
            <button 
                id="demarrer-button"
                onclick="startBootSequence()" 
                class="nes-button text-eloth-yellow pixel-font text-xl px-8 py-4 rounded-xl border-none h-14"
            >
                DÉMARRER
            </button>
        </div>

        <!-- Boot Sequence and Final Button (Starts hidden/off-screen) -->
        <div id="boot-sequence-container" class="title-start-position absolute flex flex-col items-center opacity-0 transition-opacity duration-500">
            
            <!-- ELOTH Title -->
            <h1 id="eloth-title" class="pixel-font text-white text-7xl md:text-8xl tracking-widest transition-opacity duration-1000">
                ELOTH
            </h1>

            <div class="h-8"></div>
            
            <!-- Final Start Button (Hidden initially) -->
            <div id="final-start-button-container" class="opacity-0 transition-opacity duration-500 mt-8">
                <button 
                    id="final-start-button"
                    onclick="handleFinalStartClick()" 
                    class="nes-button text-eloth-yellow pixel-font text-xl px-8 py-4 rounded-xl border-none h-14"
                >
                    Commencer !
                </button>
            </div>
        </div>
        
        <!-- Error Screen (Hidden initially) - Removed transition classes -->
        <div id="error-screen" class="hidden absolute inset-0 bg-black flex items-center justify-center opacity-0">
             <p class="error-font text-center text-white text-lg md:text-xl p-8">
                Erreur ! Le créateur de personnage n'a pas encore été créé.<br><br>
                Merci d'attendre la version finale pour enfin créer vos personnage !<br><br>
                <span class="text-sm">- Le développeur</span>
            </p>
        </div>

    </div>
</div>

<script>
    // --- State and Constants ---
    const app = {
        // State names: AWAIT_DEMARRER, BOOT_START, BUTTON_VISIBLE, FADE_OUT, ERROR_SCREEN
        state: 'AWAIT_DEMARRER', 
        history: ['AWAIT_DEMARRER'], // To track navigation flow
        starCount: 300,
        stars: [],
        lastTime: 0,
        speed: 0.005, 
        canvas: document.getElementById('starfield'),
        ctx: null
    };

    // --- DOM Elements ---
    const initialStartContainer = document.getElementById('initial-start');
    const bootSequenceContainer = document.getElementById('boot-sequence-container');
    const finalStartButtonContainer = document.getElementById('final-start-button-container');
    const elothTitle = document.getElementById('eloth-title');
    const errorScreen = document.getElementById('error-screen');
    const bootSound = document.getElementById('boot-sound'); 
    const redFlash = document.getElementById('red-flash-effect'); 
    const backButton = document.getElementById('back-button');
    const transitionFx = document.getElementById('transition-fx'); // New transition sound element

    // --- Title Animation Reset Helper ---
    function resetTitleForAnimation() {
        // 1. Temporarily disable the transition
        bootSequenceContainer.style.transition = 'none'; 
        
        // 2. Set back to the initial off-screen position
        bootSequenceContainer.classList.add('title-start-position'); // transform: translateY(-250px);
        bootSequenceContainer.style.transform = ''; // Clear inline style if any
        
        // 3. Ensure visibility is restored
        bootSequenceContainer.classList.remove('hidden');
        bootSequenceContainer.classList.remove('opacity-0');
        elothTitle.style.removeProperty('opacity');
        finalStartButtonContainer.style.opacity = '0'; // Hide button for descent

        // 4. Re-enable the transition and trigger the descent
        setTimeout(() => {
            bootSequenceContainer.style.transition = 'transform 5600ms linear, opacity 500ms';
            // Start descent by removing the starting position class
            bootSequenceContainer.classList.remove('title-start-position'); 
            bootSequenceContainer.classList.remove('absolute'); 
            bootSequenceContainer.classList.add('relative'); 
        }, 50); // Small delay required for the CSS trick to register the position change
        
        // 5. Play the sound again
        bootSound.play().catch(e => console.error("Audio playback failed:", e));
        
        // 6. Schedule state change and button visibility when descent is complete
        const duration = 5600; 
        setTimeout(() => {
            bootSound.pause();
            bootSound.currentTime = 0; 
            
            app.state = 'BUTTON_VISIBLE';
            // Show the final "Commencer !" button with a fade-in
            finalStartButtonContainer.classList.remove('opacity-0');
            finalStartButtonContainer.style.removeProperty('opacity'); // Ensure inline opacity is cleared

            backButton.classList.remove('opacity-0');
            
        }, duration + 100); // Add a small buffer
    }

    // --- History Navigation (Reset to initial state) ---
    function goBack() {
        // Prevent interaction during transition phases
        if (app.state === 'BOOT_START' || app.state === 'FADE_OUT') return;
        
        // Stop any currently running sound
        bootSound.pause();
        bootSound.currentTime = 0; 
        
        // 1. Manage History and determine target state
        if (app.history.length <= 1) return; 

        app.history.pop();
        const previousState = app.history[app.history.length - 1];
        
        // Temporarily set state to avoid immediate re-triggering while running reset
        app.state = 'TRANSITIONING'; 

        // 2. Hide common elements
        errorScreen.classList.add('hidden');
        errorScreen.style.opacity = '0'; 
        
        // Hide back button until transition is done
        backButton.classList.add('opacity-0');

        // 3. Handle state-specific visibility
        if (previousState === 'AWAIT_DEMARRER') {
            // Target: DÉMARRER screen
            app.state = 'AWAIT_DEMARRER';
            initialStartContainer.classList.remove('hidden', 'opacity-0');
            bootSequenceContainer.classList.add('opacity-0');
            finalStartButtonContainer.classList.add('opacity-0');
            
            // Clear all positioning from boot sequence container
            bootSequenceContainer.style.transition = 'none'; 
            bootSequenceContainer.classList.add('title-start-position');
            bootSequenceContainer.classList.add('absolute');
            bootSequenceContainer.classList.remove('relative');
            bootSequenceContainer.style.transform = ''; 

        } else if (previousState === 'BUTTON_VISIBLE') {
            // Target: Animated ELOTH Title screen (FIXED: Re-trigger the animation)
            initialStartContainer.classList.add('hidden', 'opacity-0');
            
            // Re-trigger the full boot animation sequence
            resetTitleForAnimation();
            
            // Note: app.state is set to 'BUTTON_VISIBLE' inside resetTitleForAnimation
        }
    }

    // --- Starfield Implementation (Canvas API) ---

    function initStarfield() {
        if (!app.canvas.getContext) return;
        app.ctx = app.canvas.getContext('2d');
        resizeCanvas();

        for (let i = 0; i < app.starCount; i++) {
            app.stars.push({
                x: Math.random() * app.canvas.width,
                y: Math.random() * app.canvas.height,
                size: Math.random() * 2 + 1,
            });
        }
        window.addEventListener('resize', resizeCanvas);
        app.lastTime = performance.now();
        requestAnimationFrame(animateStarfield);
    }

    function resizeCanvas() {
        app.canvas.width = window.innerWidth;
        app.canvas.height = window.innerHeight;
    }

    function animateStarfield(currentTime) {
        if (app.state === 'ERROR_SCREEN') return;

        const deltaTime = currentTime - app.lastTime;
        app.lastTime = currentTime;

        app.ctx.fillStyle = 'black';
        app.ctx.fillRect(0, 0, app.canvas.width, app.canvas.height);

        app.ctx.fillStyle = 'white';
        app.stars.forEach(star => {
            star.y += app.speed * deltaTime; 
            if (star.y > app.canvas.height) {
                star.y = 0; 
                star.x = Math.random() * app.canvas.width; 
            }

            app.ctx.globalAlpha = 0.7;
            app.ctx.beginPath();
            app.ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
            app.ctx.fill();
        });
        
        requestAnimationFrame(animateStarfield);
    }
    
    // --- Boot Sequence Logic ---

    function startBootSequence() {
        if (app.state !== 'AWAIT_DEMARRER') return;
        app.state = 'BOOT_START';
        
        // Track history
        app.history.push('BUTTON_VISIBLE');
        
        // Hide the back button while the main sequence is running
        backButton.classList.add('opacity-0');

        // 1. Hide the initial DÉMARRER button with fade-out
        initialStartContainer.classList.add('opacity-0');
        setTimeout(() => {
            initialStartContainer.classList.add('hidden');
        }, 500);

        // 2. Make the boot sequence container visible (it's still off-screen)
        bootSequenceContainer.classList.remove('opacity-0');
        
        // 3. Start the background sound 
        bootSound.play().catch(e => console.error("Audio playback failed:", e));

        // 4. Start the title descent animation (after a small delay to ensure visibility)
        setTimeout(() => {
            // Ensure transition is back on
            bootSequenceContainer.style.transition = 'transform 5600ms linear, opacity 500ms';
            
            // Initiate descent by removing the starting position class
            bootSequenceContainer.classList.remove('title-start-position');
            // Switch positioning for the descent to work correctly with CSS transition
            bootSequenceContainer.classList.remove('absolute'); 
            bootSequenceContainer.classList.add('relative'); 
            
            // 5. Wait for title animation to finish (5600ms new duration)
            const newDuration = 5600; 
            setTimeout(() => {
                // Stop the sound immediately when the descent finishes 
                bootSound.pause();
                bootSound.currentTime = 0; 
                
                app.state = 'BUTTON_VISIBLE';
                // 6. Show the final "Commencer !" button with a fade-in (500ms transition)
                finalStartButtonContainer.classList.remove('opacity-0');

                // SHOW the back button now that the boot sequence is complete
                backButton.classList.remove('opacity-0');
                
            }, newDuration); 

        }, 100); 
    }

    function handleFinalStartClick() {
        if (app.state !== 'BUTTON_VISIBLE') return;
        app.state = 'FADE_OUT';
        
        // Track history
        app.history.push('ERROR_SCREEN');
        
        // Play the transition sound effect immediately 
        transitionFx.play().catch(e => console.error("Transition audio playback failed:", e));
        
        // Hide back button during the final transition 
        backButton.classList.add('opacity-0');
        
        // 1. Force the flash element to expand and appear instantly (no transition)
        redFlash.style.transition = 'none'; 
        redFlash.style.opacity = '1';
        redFlash.style.transform = 'translate(-50%, -50%) scale(50)'; 
        
        // 2. Hide boot sequence elements immediately using inline styles
        elothTitle.style.opacity = '0';
        finalStartButtonContainer.style.opacity = '0'; 

        // 3. Schedule the fade-out after a minimal delay
        setTimeout(() => {
            // Enable transition for opacity only (fade-out)
            redFlash.style.transition = 'opacity 750ms ease-out'; 
            redFlash.style.opacity = '0'; // Start fading out while staying expanded
        }, 50); 
        
        // 4. Wait for the fade-out to complete (750ms) PLUS an extra 500ms buffer (1350ms total delay)
        setTimeout(() => {
            app.state = 'ERROR_SCREEN';
            
            // Hide the boot container completely 
            bootSequenceContainer.classList.add('hidden');
            
            // Show error screen abruptly
            errorScreen.classList.remove('hidden');
            errorScreen.style.opacity = '1'; 

            // SHOW the back button now that the error message is fully displayed
            backButton.classList.remove('opacity-0');
            
        }, 1350); 
    }
    
    // --- Initialization ---
    window.onload = function() {
        initStarfield();
    };

</script>

</body>
</html>